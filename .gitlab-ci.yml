stages:
  - validate
  - plan
  - apply
  - verify

variables:
  TF_ROOT: terraform

image: cimg/python:3.11

before_script:
  # Ton before_script existant INCHANGÉ
  - mkdir -p bin
  - curl -L -o terraform.zip https://releases.hashicorp.com/terraform/1.9.5/terraform_1.9.5_linux_amd64.zip
  - cd bin && unzip -o ../terraform.zip terraform && cd ..
  - chmod +x bin/terraform
  - export PATH="$PWD/bin:$HOME/.local/bin:$PATH"
  - pip install --user ansible yamllint ansible-lint ansible-vault
  - ~/.local/bin/ansible-galaxy collection install -r ansible/requirements.yml || true
  - cd $TF_ROOT && terraform init
  - terraform version && ansible --version || true

# Tes jobs existants INCHANGÉS
validate:
  stage: validate
  script:
    - cd $TF_ROOT && terraform validate
  rules:
    - changes:
        - terraform/**/*

terraform-plan:
  stage: plan
  script:
    - cd $TF_ROOT
    - terraform plan -var="sdwan_url=$VMANAGE_URL" \
                     -var="sdwan_username=$VMANAGE_USER" \
                     -var="sdwan_password=$VMANAGE_PASS" \
                     -var="sdwan_insecure=true" -out=tfplan
  artifacts:
    paths: [$TF_ROOT/tfplan]
  rules:
    - if: $CI_MERGE_REQUEST_ID

terraform-apply:
  stage: apply
  script:
    - cd $TF_ROOT && terraform apply -auto-approve tfplan
  when: manual
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
